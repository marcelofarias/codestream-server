#!/bin/bash

# re-generate codestream config files and config templates for distribution

function diff_notify {
	local file=$1 ask=$2
	local ans
	if [ ! -f $file ]; then
		echo "$file is new"
		# echo mv $file.x $file
		mv $file.x $file
		return
	fi
	x=`diff $file $file.x|wc -l`
	if [ $x -gt 0 ]; then
		echo "$file has changed"
		if [ -n "$ask" ]; then
			echo -n "update it (y/N)? "
			read ans
			[ "$ans" != y ] && /bin/rm $file.x && echo "skipped" && return
		fi
		# echo mv $file.x $file
		mv $file.x $file
	else
		# echo "$file did not change"
		/bin/rm $file.x
	fi
}

[ -z "$KM_PKI" ] && echo "Set KM_PKI to the location of the PKI database" && exit 1
[ "$1" == "-y" ] && yes="" || yes=y
binDir=`dirname $0`
repoRoot=`dirname $binDir`

$binDir/process-profile --show-desc --out $repoRoot/README.parameter-definitions.json.x
diff_notify $repoRoot/README.parameter-definitions.json "$yes"

# template for on-prem with docker
$binDir/process-profile --profile $repoRoot/profiles/onprem-single-host-preview-template.json --out $repoRoot/../onprem-install/config-templates/single-host-preview-minimal-cfg.json.template.x
diff_notify ~/src/onprem-install/config-templates/single-host-preview-minimal-cfg.json.template "$yes"

# configs for development (distributed via dt-update-secrets)
$binDir/process-profile --profile $repoRoot/profiles/cloud.json --env local --out $KM_PKI/secrets/configs/local-cloud-development.json.x
diff_notify $KM_PKI/secrets/configs/local-cloud-development.json "$yes"
